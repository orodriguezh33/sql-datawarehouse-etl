services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    platform: linux/amd64
    container_name: ${MSSQL_CONTAINER}
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: ${MSSQL_SA_PASSWORD}
      MSSQL_PID: "Developer"
    ports:
      - "${MSSQL_PORT}:1433"
    volumes:
      - mssql_data:/var/opt/mssql
      - ./datasets:/datasets:ro
      - ./sql:/sql:ro
    restart: unless-stopped
    init: true
    healthcheck:
      test:
        [
          "CMD",
          "/opt/mssql-tools18/bin/sqlcmd",
          "-S", "localhost,1433",
          "-U", "sa",
          "-P", "${MSSQL_SA_PASSWORD}",
          "-Q", "SELECT 1",
          "-C"
        ]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 20s

  etl:
    build: .
    platform: linux/amd64
    container_name: etl_runner
    depends_on:
      sqlserver:
        condition: service_healthy
    environment:
      MSSQL_HOST: ${MSSQL_HOST:-sqlserver}
      MSSQL_PORT: ${MSSQL_PORT:-1433}
      MSSQL_USER: ${MSSQL_USER:-sa}
      MSSQL_SA_PASSWORD: ${MSSQL_SA_PASSWORD}
      MSSQL_DB: ${MSSQL_DB:-DataWarehouse}
      SQL_BASE_PATH: ${SQL_BASE_PATH:-/sql}
      SQLCMD_PATH: ${SQLCMD_PATH:-/opt/mssql-tools18/bin/sqlcmd}
    volumes:
      - ./logs:/app/logs
      - ./sql:/sql:ro
      - ./datasets:/datasets:ro
    restart: "no"
    command: ["python", "main.py"]

volumes:
  mssql_data:
